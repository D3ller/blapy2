(function(){"use strict";class Logger{constructor({debug:t=!1,logLevel:e=2,alertError:a=!1}={}){this.debug=!1,this.logLevel=3,this.alertError=a}error(t,e="blapy"){this.log(t,1,e)}warn(t,e="blapy"){this.log(t,2,e)}info(t,e="blapy"){this.log(t,3,e)}log(t,e=3,a="blapy"){if((!(e>=2)||this.debug)&&("undefined"!=typeof window&&window.console&&window.console.log||"undefined"!=typeof console))switch(e){case 1:console.error(`[Blapy2] ${t} from ${a}`);break;case 2:console.warn(`[Blapy2] ${t} from ${a}`);break;default:console.log(`[Blapy2] ${t} from ${a}`)}}}class Utils{atou(t){return decodeURIComponent(atob(t))}utoa(t){return btoa(unescape(encodeURIComponent(t)))}}class TemplateManager{constructor(t,e,a){this.logger=t,this.ajaxService=e,this.utils=a,this.templates=new Map}async setBlapyContainerJsonTemplate(t,e,a=!1){this.logger.info("setBlapyContainerJsonTemplate","template manager"),t.setAttribute("data-blapy-update-rule","local");let n=Array.from(t.children).filter(t=>t.hasAttribute("data-blapy-container-tpl")),r=t.innerHTML;if(0===n.length){try{const t=document.createElement("div");t.innerHTML=r.trim();const e=t.firstElementChild;e&&"XMP"===e.tagName&&(r=e.innerHTML)}catch(i){this.logger.error("htmlTplContent from "+t.id+" is not html template...?\n"+r)}if(""==r.replace(/(<!--.*?-->)|(<!--[\S\s]+?-->)|(<!--[\S\s]*?$)/g,"").replace(/\s{2,}/g," ").replace(/\t/g," ").replace(/(\r\n|\n|\r)/g,"").replace(/(\/\*[^*]*\*\/)|(\/\/[^*]*)/g,"").trim()){let a=t.getAttribute("data-blapy-template-file"),n="1"==t.getAttribute("data-blapy-noblapydata")?"":"blapycall=1&blapyaction=loadTpl&blapyobjectid="+t.getAttribute("id");if(a&&!this.templates.has(a)){r=await this.ajaxService.get(a,{params:n}),r=r.replace(/<!--(.*?)-->/gm,"").replaceAll("\n\n","\n").replaceAll("\t\t","\t"),"xmp"!==r.replace(/{{(.*?)}}/gm,"").split("script").join("scriptblapy").split("img").join("imgblapy").tagName?(r='<xmp style="display:none" data-blapy-container-tpl="true">'+r+"</xmp>",t.innerHTML=r):t.innerHTML=r,this.templates.set(a,r),this._initializeJsonBlock(t,!1,e)}else a&&this.templates.has(a)?(this.logger.info("The templates use cache memory"),t.innerHTML=this.templates.get(a),this._initializeJsonBlock(t,!1,e)):this._initializeJsonBlock(t,!1,e)}else{"xmp"!==r.replace(/{{(.*?)}}/gm,"").split("script").join("scriptblapy").split("img").join("imgblapy").tagName?(r='<xmp style="display:none" data-blapy-container-tpl="true">'+r+"</xmp>",t.innerHTML=r):t.innerHTML=r,this._initializeJsonBlock(t,!1,e)}}else a&&this._initializeJsonBlock(t,!0,e)}getObjects(t,e,a){let n=[];for(let r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]?n=n.concat(this.getObjects(t[r],e,a)):(r==e&&t[r]==a||r==e&&""==a||t[r]==a&&""==e&&-1==n.lastIndexOf(t))&&n.push(t));return n}_initializeJsonBlock(t,e=!1,a=a){this.logger.info("_initializeJsonBlock","template manager"),t.getAttribute("data-blapy-container-name"),t.getAttribute("data-blapy-template-init");let n=null;if(n="undefined"==typeof JSON5?JSON:JSON5,!e&&t.getAttribute("data-blapy-updateblock-ondisplay")&&"done"!==t.getAttribute("data-blapy-appear"))return;let r=t.getAttribute("data-blapy-template-init");if(r){let e=t.getAttribute("data-blapy-template-init-params");e=null!=e?n.parse(e):{},"0"!==t.getAttribute("data-blapy-template-init-purejson")&&(e={...e,embeddingBlockId:t.getAttribute("data-blapy-container-name")});let i=t.getAttribute("data-blapy-noblapydata");null==i&&(i="0");let o=t.getAttribute("data-blapy-template-init-method");null==o&&(o="GET"),a.myFSM.trigger("postData",{aUrl:r,params:e,method:o,noBlapyData:i})}t.id&&a.trigger("Blapy_templateReady",{detail:t})}async processJsonUpdate(t,e,a,n,r){try{const i=await this._extractAndParseJsonData(t,a,n),o=e.getAttribute("data-blapy-container-name");if(console.log(`🎨 [${o}] processJsonUpdate started`),console.log(`🎨 [${o}] tmpContainer:`,!!t),console.log(`🎨 [${o}] JSON data extracted:`,!!i),i&&console.log(`🎨 [${o}] JSON preview:`,JSON.stringify(i).substring(0,100)),!i)return;const l=this._applyDataTransformations(i,e,n);console.log(`🔄 [${o}] Data transformations completed`);const s=this._getTemplate(e);if(console.log(`🎭 [${o}] Template found:`,!!s),!s)return;const p=this._generateHtml(l,s,e);console.info(p),console.log(`🏭 [${o}] HTML generated, length:`,p.length),console.log(`🏭 [${o}] HTML preview:`,p),this._injectFinalHtml(p,e,r,s)}catch(i){this.logger.error(`Erreur dans processJsonUpdate: ${i.message}`,"templateManager")}}async _extractAndParseJsonData(t,e,a){this.logger.info("_extractAndParseJsonData","templateManager");let n=t?this.utils.atou($(t).html()):$(e).html();n=n.trim().replace(/(\r\n|\n|\r)/g,"");try{const t=a.parse(n);return this._extractBlapyData(t,e)}catch(r){this.logger.warn("Premier parsing échoué, tentative d'extraction HTML","templateManager");try{n=$(n).html();const t=n.replace(/(\r\n|\n|\r)/g,""),r=a.parse(t);return this._extractBlapyData(r,e)}catch(i){throw this.logger.error("Parsing impossible même après extraction HTML"+n,"templateManager"),new Error("Parsing JSON impossible")}}}_extractBlapyData(t,e=null){if(this.logger.info("_extractBlapyData","templateManager"),t["blapy-data"]&&t["blapy-container-name"]){const a=e?.getAttribute?.("data-blapy-container-name");return a&&t["blapy-container-name"]!=a?(this.logger.warn("blapy-data set: "+JSON.stringify(t)+"\n but not match with containerName "+a),null):t["blapy-data"]}return t}_applyDataTransformations(t,e,a){this.logger.info("_applyDataTransformations","templateManager");let n=t;return n=this._applyInitFromProperty(n,e),n=this._applyInitSearch(n,e),n=this._applyProcessDataFunctions(n,e,a),this._addBlapyIndices(n)}_applyInitFromProperty(t,e){if(this.logger.info("_applyInitFromProperty","templateManager"),!e.hasAttribute("data-blapy-template-init-fromproperty")||""===e.getAttribute("data-blapy-template-init-fromproperty"))return t;try{this.logger.info("Apply data-blapy-template-init-fromproperty: "+e.getAttribute("data-blapy-template-init-fromproperty"));const a=e.getAttribute("data-blapy-template-init-fromproperty");if(a){return a.split(".").reduce((t,e)=>void 0!==t[e]?t[e]:t,t)}return t}catch(a){return this.logger.error("init-search or init-property does not work well on json data of container: "+e.id,"templateManager"),t}}_applyInitSearch(t,e){this.logger.info("_applyInitSearch","templateMnager");const a=e.getAttribute("data-blapy-template-init-search");if(!a||""===a)return t;try{this.logger.info("Apply data-blapy-template-init-search: "+e.getAttribute("data-blapy-template-init-search"));JSON.stringify(t);return t=(t=a.split(",").map(t=>t.split("==")).reduce((e,a)=>{const n=this.getObjects(t,a[0],a[1]);return n.length?e.concat(n):e},[])).filter((e,a)=>a===t.findIndex(t=>JSON.stringify(t)===JSON.stringify(e)))}catch(n){return this.logger.error("init-search or init-property does not work well on json data of container: "+e.id,"templateManager"),t}}_applyProcessDataFunctions(jsonDataObj,myContainer,jsonFeatures){if(this.logger.info("_applyProcessDataFunctions","templateManager"),!myContainer.hasAttribute("data-blapy-template-init-processdata")||""===myContainer.getAttribute("data-blapy-template-init-processdata"))return jsonDataObj;let aJsonDataFunction=myContainer.getAttribute("data-blapy-template-init-processdata");return aJsonDataFunction&&(this.logger.info("Apply data-blapy-template-init-processdata: "+aJsonDataFunction),aJsonDataFunction.split(",").forEach(aFunctionName=>{let previousJsonDataObj=jsonFeatures;eval("if (typeof "+aFunctionName+' === "function")    jsonDataObj='+aFunctionName+'(jsonDataObj);else     this.logger.error("'+aFunctionName+" does not exist :(! Have a look on the : data-blapy-template-init-processdata of container "+myContainer.id+'", "templateManager");'),"object"!=typeof jsonDataObj&&(this.logger.error("returned Json Data was not a json structure :(! Perhaps it is due to the processing of this function on them: "+aJsonDataFunction,"templateManager"),jsonDataObj=previousJsonDataObj)})),jsonDataObj}_addBlapyIndices(t){if(t.length)for(let e=0;e<t.length;e++)null==t[e].blapyIndex&&(t[e].blapyIndex=e+1),0==e&&(t[e].blapyFirst=!0),e==t.length-1&&(t[e].blapyLast=!0);else t.blapyIndex=0;return t}_getTemplate(t){let e="",a=t.querySelectorAll("[data-blapy-container-tpl]"),n="",r=t.getAttribute("data-blapy-template-default-id");if(null!=r&&""!=r){let a=`:scope > [data-blapy-container-tpl][data-blapy-container-tpl-id='${r}']`;e=t.querySelectorAll(a),0==e.length&&this.logger.error("The json template of id "+r+" was not found for the block "+t.getAttribute("data-blapy-container-name")+"!","templateManager")}return 0==e.length&&(e=a),0==e.length?(n="",this.logger.error("can not find any json template for the block: "+t.getAttribute("data-blapy-container-name"),"templateManager"),null):(n=e[0].innerHTML,n.length<3?(this.logger.error("Template is void... ? "+t.getAttribute("data-blapy-container-name"),"templateManager"),null):{content:n,allTemplates:a})}_generateHtml(t,e,a){let n=this._prepareTemplateContent(e.content),r="",i=!1;const o=JSON.stringify(t);if("undefined"!=typeof Mustache){let e="{{",o="}}",l="";a.hasAttribute("data-blapy-template-mustache-delimiterStart")&&""!==a.getAttribute("data-blapy-template-mustache-delimiterStart")&&(e=a.getAttribute("data-blapy-template-mustache-delimiterStart"),o=a.getAttribute("data-blapy-template-mustache-delimiterEnd"),l="{{="+e+" "+o+"=}}"),(""!=l||n.includes("{{"))&&(r=Mustache.render(l+e+"#."+o+n+e+"/."+o,t),i=!0)}return i||"undefined"==typeof json2html||(r=json2html.transform(o,{tag:"void",html:n}),r=r.replace(/<.?void>/g,""),i=!0),i?r:(this.logger.error("no json parser loaded... need to include json2html or Mustache library! ","templateManager"),alert('no json parser loaded... need to include "json2html" or "Mustache" library!'),"")}_prepareTemplateContent(t){return t.replace(/\|xmp/gi,"xmp").replace(/\|\/xmp/gi,"/xmp").replace(/blapyScriptJS/gi,"script")}_injectFinalHtml(t,e,a,n){let r=t;if(e.hasAttribute("data-blapy-template-header")&&(this.logger.info("Apply data-blapy-template-header"),r=e.getAttribute("data-blapy-template-header")+r),e.hasAttribute("data-blapy-template-footer")&&(this.logger.info("Apply data-blapy-template-footer"),r+=e.getAttribute("data-blapy-template-footer")),e.hasAttribute("data-blapy-template-wrap")){this.logger.info("Apply data-blapy-template-wrap");const t=e.getAttribute("data-blapy-template-wrap"),a=document.createElement("div");a.innerHTML=t,a.firstElementChild.innerHTML=r,r=a.firstElementChild.outerHTML}let i="";n&&n.allTemplates&&n.allTemplates.forEach(t=>{i+=t.outerHTML}),console.log("💉 tplList:",i),console.log("💉 newHtml:",r),e.innerHTML=i+r,console.log("💉 Final innerHTML:",e.innerHTML);e.querySelectorAll("script").forEach(t=>{const e=document.createElement("script");t.src?e.src=t.src:e.textContent=t.textContent,t.parentNode.replaceChild(e,t)}),setTimeout(()=>{const t=e.querySelectorAll('[data-blapy-update="json"]');if(t.length>0){a.myFSM.trigger("blapyJsonTemplatesToSet");let e=this;!async function(){for(const n of t)e.logger.error(`Initializing sub-block: ${n.getAttribute("data-blapy-container-name")}`,"templateManager"),await e.setBlapyContainerJsonTemplate(n,a);a.myFSM.trigger("blapyJsonTemplatesIsSet")}()}else a.myFSM.trigger("blapyJsonTemplatesIsSet")},0)}}class Router{constructor(t,e,a={}){this.logger=t,this.blapy=e,this.opts={enableRouter:!1,root:"/",hash:!1,strategy:"ONE",noMatchWarning:!1,linksSelector:"[data-blapy-link]",...a},this.router=null,this.isInitialized=!1}init(){return this.logger.info("Router initialization starting...","router"),this.opts.enableRouter?"function"!=typeof Navigo?(this.logger.error("Navigo is not loaded... can not continue","router"),alert("Navigo is not loaded... can not continue"),!1):(this._initNavigoRouter(),!0):(this.logger.info("Router disabled, using standard event handlers","router"),this._initStandardHandlers(),!0)}_initStandardHandlers(){this.logger.info("Initializing standard event handlers (no routing)","router");const t=this.blapy.container;t.addEventListener("click",t=>{const e=t.target.closest("a[data-blapy-link]");if(!e)return;const a=e.getAttribute("data-blapy-active-blapyid");if(a&&a!==this.blapy.myUIObjectID)return;t.preventDefault();const n=this._extractLinkParams(e),r=e.getAttribute("data-blapy-embedding-blockid");r&&(n.embeddingBlockId=r),this.logger.info(`Standard link clicked: ${e.href}`,"router"),this.blapy.myFSM.trigger("postData",{aUrl:this._extractUrl(e.href),params:n,method:e.getAttribute("method")||"GET",aObjectId:this.blapy.myUIObjectID,noBlapyData:e.getAttribute("data-blapy-noblapydata")})}),t.addEventListener("submit",t=>{const e=t.target;if(!e.matches("form[data-blapy-link]"))return;const a=e.getAttribute("data-blapy-active-blapyid");if(a&&a!==this.blapy.myUIObjectID)return;t.preventDefault(),this.logger.info(`Form submitted: ${e.action}`,"router");const n=this._extractFormData(e,t),r=e.getAttribute("data-blapy-embedding-blockid");r&&(n.embeddingBlockId=r),this.blapy.myFSM.trigger("postData",{aUrl:this._extractUrl(e.action),params:n,method:e.getAttribute("method")||"POST",aObjectId:this.blapy.myUIObjectID,noBlapyData:e.getAttribute("data-blapy-noblapydata")})})}_initNavigoRouter(){this.logger.info("Initializing simple router (manual history management)","router"),this._interceptBlapyLinks(),window.addEventListener("popstate",t=>{this.logger.info("Popstate event detected","router"),this.blapy.myFSM.trigger("loadUrl",{aUrl:window.location.pathname+window.location.search,params:{},aObjectId:this.blapy.myUIObjectID})}),this.isInitialized=!0,this.logger.info("Simple router initialized","router")}_handleBlapyLink(t,e="GET"){const a=t.url||t.route.path;this.logger.info(`Navigo route matched: ${e} ${a}`,"router");const n=document.querySelector(`[href="${a}"], [action="${a}"]`);if(n){const t=n.getAttribute("data-blapy-active-blapyid");if(t&&t!==this.blapy.myUIObjectID)return void this.logger.info(`Route filtered - not for this Blapy instance: ${t}`,"router")}const r=this._extractEmbeddingBlockId(a),i={...t.params,...t.data||{}};r&&(i.embeddingBlockId=r);const o=this._cleanBlapyUrl(a);console.log(o),"GET"===e?this.blapy.myFSM.trigger("loadUrl",{aUrl:o,params:this._filterAttributes(i),aObjectId:this.blapy.myUIObjectID,noBlapyData:n?.getAttribute("data-blapy-noblapydata")}):this.blapy.myFSM.trigger("postData",{aUrl:o,params:this._filterAttributes(i),aObjectId:this.blapy.myUIObjectID,method:e.toLowerCase(),noBlapyData:n?.getAttribute("data-blapy-noblapydata")})}_extractEmbeddingBlockId(t){const e=/#blapylink#(.*)/i.exec(t);return e&&e[1]?e[1]:""}_cleanBlapyUrl(t){return t.replace(/#blapylink.*$/,"")}_filterAttributes(t){const e={};for(const[a,n]of Object.entries(t))"function"!=typeof n&&"object"!=typeof n&&(e[a]=n);return e}_extractLinkParams(t){const e=t.getAttribute("data-blapy-params");if(!e)return{};try{return("undefined"!=typeof JSON5?JSON5:JSON).parse(e)}catch(a){return this.logger.warn(`Failed to parse link params: ${e}`,"router"),{}}}_extractFormData(t,e){const a=new FormData(t),n={};for(const[r,i]of a.entries())n[r]=i;if(e.submitter){const t=e.submitter;t.name&&(n[t.name]=t.value||"")}else if(e.originalEvent&&e.originalEvent.submitter){const t=e.originalEvent.submitter;t.name&&(n[t.name]=t.value||"")}return n}_extractUrl(t){if(!t)return window.location.href;const e=t.indexOf("#");return-1!==e?t.substring(0,e):t}navigate(t,e={}){if(!this.isInitialized||!this.router)return void this.logger.warn("Router not initialized, cannot navigate","router");this.logger.info(`Navigating to: ${t}`,"router");const a={title:e.title,stateObj:e.stateObj,historyAPIMethod:e.historyAPIMethod||"pushState",updateBrowserURL:!1!==e.updateBrowserURL,callHandler:!1!==e.callHandler,callHooks:!1!==e.callHooks,updateState:!1!==e.updateState,force:e.force||!1};this.router.navigate(t,a)}resolve(t){return this.isInitialized&&this.router?this.router.resolve(t):(this.logger.warn("Router not initialized, cannot resolve","router"),!1)}destroy(){this.router&&(this.router.destroy(),this.router=null,this.isInitialized=!1,this.logger.info("Router destroyed","router"))}_interceptBlapyLinks(){this.blapy.container.addEventListener("click",t=>{const e=t.target.closest("a[data-blapy-link]");if(!e)return;const a=e.getAttribute("href");if(!a||!a.includes("#blapylink"))return;const n=e.getAttribute("data-blapy-active-blapyid");if(n&&n!==this.blapy.myUIObjectID)return;t.preventDefault();const r=this._extractLinkParams(e),i=this._extractEmbeddingBlockId(a);i&&(r.embeddingBlockId=i);const o=this._cleanBlapyUrl(a);window.history.pushState({blapy:!0},"",o),this.logger.info(`Navigating to: ${o}`,"router"),this.blapy.myFSM.trigger("loadUrl",{aUrl:o,params:this._filterAttributes(r),aObjectId:this.blapy.myUIObjectID,noBlapyData:e.getAttribute("data-blapy-noblapydata")})})}}class BlapyBlock{constructor(t,e,a){this.logger=t,this.templateManager=e,this.ajaxService=a,this.blocks=new Map,this.intervalsSet=new Map,this.visibilityObserver=null,this.blapy=null,this.logger.info("BlapyBlocks initialized","blocks")}setBlapyInstance(t){this.blapy=t}initializeBlocks(t){this.logger.info("Initializing Blapy blocks","blocks");t.querySelectorAll('[data-blapy-container="true"]').forEach(t=>{const e=t.getAttribute("data-blapy-container-name");e?(this.blocks.set(e,{element:t,name:e}),this.logger.info(`Block registered: ${e}`,"blocks")):this.logger.warn("Block without container name found","blocks")})}setBlapyUpdateIntervals(){this.logger.info("Setting up update intervals","blocks"),this.intervalsSet.forEach(t=>clearInterval(t)),this.intervalsSet.clear();const t=this.blapy.myUIObject.querySelectorAll("[data-blapy-updateblock-time]");let e=0;t.forEach(t=>{const a=parseInt(t.getAttribute("data-blapy-updateblock-time")),n=t.getAttribute("data-blapy-href"),r=t.getAttribute("data-blapy-container-name"),i=t.getAttribute("data-blapy-noblapydata");if(a&&n){this.logger.info(`Setting interval for ${r}: ${a}ms`,"blocks");const t=n+"?blapyContainerName="+r,o=setInterval(()=>{this.logger.info(`Interval triggered for ${r}`,"blocks"),this.blapy.myFSM.trigger("loadUrl",{aUrl:t,params:{},aObjectId:this.blapy.myUIObjectID,noBlapyData:i})},a);this.intervalsSet.set(e,o),e++,this.logger.info(`✅ Interval set for ${r}: ${a}ms (index: ${e-1})`,"blocks")}else a||this.logger.warn(`Block ${r} has no update time`,"blocks"),n||this.logger.warn(`Block ${r} has no href`,"blocks")}),this.logger.info(`Total intervals set: ${this.intervalsSet.size}`,"blocks")}}class AjaxService{constructor(t){this.logger=t}async request(t,e={}){if(!t)throw new Error("URL is required");const{method:a="GET",body:n=null,headers:r={},params:i=null,timeout:o=3e4}=e;return new Promise((e,l)=>{const s=new XMLHttpRequest;let p=t;if("GET"===a.toUpperCase()&&i){const e=new URLSearchParams(i);p+=(t.includes("?")?"&":"?")+e.toString()}s.open(a.toUpperCase(),p,!0),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),Object.entries(r).forEach(([t,e])=>{s.setRequestHeader(t,e)}),s.timeout=o,s.onload=()=>{if(s.status>=200&&s.status<300)try{const t=s.getResponseHeader("content-type");if(t&&t.includes("application/json")){const t=JSON.parse(s.responseText);this.logger?.info(`AJAX Success (JSON): ${a} ${p}`,{status:s.status,dataKeys:Object.keys(t)}),e(t)}else this.logger?.info(`AJAX Success (Text): ${a} ${p}`,{status:s.status,responseLength:s.responseText.length}),e(s.responseText)}catch(t){this.logger?.info(`AJAX Success (Raw): ${a} ${p}`,{status:s.status,parseError:t.message}),e(s.responseText)}else{const t=new Error(`HTTP ${s.status}: ${s.statusText}`);this.logger?.error(`AJAX Error: ${a} ${p}`,{status:s.status,statusText:s.statusText,response:s.responseText}),l(t)}},s.onerror=()=>{const t=new Error("Network error occurred");this.logger?.error(`AJAX Network Error: ${a} ${p}`),l(t)},s.ontimeout=()=>{const t=new Error(`Request timeout after ${o}ms`);this.logger?.error(`AJAX Timeout: ${a} ${p}`),l(t)},"GET"!==a.toUpperCase()&&n?this._sendWithBody(s,n):s.send()})}_sendWithBody(t,e){if(e instanceof FormData)t.send(e);else if("string"==typeof e)t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(e);else if(e&&"object"==typeof e){const a=new URLSearchParams;Object.entries(e).forEach(([t,e])=>{null!=e&&a.append(t,e.toString())}),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(a.toString())}else t.send()}async get(t,e={}){return this.request(t,{...e,method:"GET"})}async post(t,e,a={}){return this.request(t,{...a,method:"POST",body:e})}}class Blapy{constructor(t,e={}){if(!t)throw new Error("Blapy needs a valid DOM element");if("string"==typeof t){const e=document.querySelector(t);if(!e)throw new Error(`Element not found: ${t}`);t=e}if(!(t instanceof HTMLElement))throw new Error("Blapy needs a valid DOM element");if(!t.id)throw new Error("Blapy needs an element with an ID");this.container=t,this.defaults={debug:!1,logLevel:2,alertError:!1,enableRouter:!1,routerRoot:"/",routerHash:!1,pageLoadedFunction:null,pageReadyFunction:null,beforePageLoad:null,beforeContentChange:null,afterContentChange:null,afterPageChange:null,onErrorOnPageChange:null,doCustomChange:null,fsmExtension:null,LogLevelIfsm:1,debugIfsm:!1},this.opts={...this.defaults,...e},this.optsIfsm=this.opts,this.optsIfsm.debug=this.opts.debugIfsm,this.optsIfsm.logLevel=this.opts.LogLevelIfsm,this.myUIObject=this.container,this.myUIObjectID=this.container.id,this.utils=new Utils,this.logger=new Logger(this.opts),this.ajaxService=new AjaxService(this.logger),this.templateManager=new TemplateManager(this.logger,this.ajaxService,this.utils),this.router=new Router(this.logger,this,{enableRouter:this.opts.enableRouter,root:this.opts.routerRoot,hash:this.opts.routerHash,strategy:"ONE",noMatchWarning:!1,linksSelector:"[data-blapy-link]"}),this.blapyBlocks=new BlapyBlock(this.logger,this.templateManager,this.ajaxService),this.blapyBlocks.initializeBlocks(this.container),this.blapyBlocks.setBlapyInstance(this),this.myFSM=null,this.opts.theBlapy=this,this.logger.info(`Blapy instance (#${this.myUIObjectID}) created`,"Blapy2 constructor")}async initApplication(){this.logger.info("InitApplication","core");try{const t={PageLoaded:{enterState:{init_function:function(){this.opts.theBlapy.myFSM=this,this.opts.theBlapy.logger.info("Page loaded","fsm"),this.opts.theBlapy.blapyBlocks.setBlapyUpdateIntervals(),this.opts.pageLoadedFunction&&this.opts.pageLoadedFunction(),this.opts.theBlapy.trigger("Blapy_PageLoaded")},next_state:"PreparePage"}},PreparePage:{enterState:{init_function:function(){},propagate_event:"setBlapyUrl"},setBlapyUrl:{init_function:function(){this.opts.theBlapy.setBlapyURL()},next_state:"PreparePage_setBlapyJsonTemplates"}},PreparePage_setBlapyJsonTemplates:{enterState:{init_function:function(){this.opts.theBlapy.setBlapyJsonTemplates()},next_state:"PreparePage_setBlapyUpdateOnDisplay"}},PreparePage_setBlapyUpdateOnDisplay:{blapyJsonTemplatesIsSet:{init_function:function(){this.opts.theBlapy.setBlapyUpdateOnDisplay()},next_state:"PageReady"},reloadBlock:"loadUrl",updateBlock:"loadUrl",postData:"loadUrl",loadUrl:{how_process_event:{delay:50,preventcancel:!0},propagate_event:!0}},PageReady:{enterState:{init_function:function(){this.opts.pageReadyFunction&&this.opts.pageReadyFunction(),this.opts.theBlapy.trigger("Blapy_PageReady")}},loadUrl:{init_function:function(t,e,a){a.method="GET",this.trigger("postData",a)}},postData:{init_function:function(t,e,a){this.opts.beforePageLoad&&this.opts.beforePageLoad(a),this.opts.theBlapy.trigger("Blapy_beforePageLoad",a)},out_function:function(t,e,a){let n=a.aUrl,r=a.noBlapyData,i=a.aObjectId?a.aObjectId:e.currentTarget.id;null==i&&void 0!==e.currentTarget.attr&&(i=e.currentTarget[0].id),a.params||(a.params={});let o=JSON.parse(JSON.stringify(a.params)),l=JSON.parse(JSON.stringify(a.params));l?l.blapyaction||(l.blapyaction="update"):l={blapyaction:"update"},"embeddingBlockId"in l&&!l.embeddingBlockId&&this.opts.theBlapy.logger.error("[postData on "+this.myUIObjectID+"] embeddingBlockId has been set but is undefined! must be an error...");let s=l.embeddingBlockId;if(s&&l.templateId){this.opts.theBlapy.myUIObject.querySelectorAll("[data-blapy-container-name='"+s+"']").forEach(t=>{t.setAttribute("data-blapy-template-default-id",l.templateId)})}let p=a.method;p||(p="POST"),l=Object.assign(l,{blapycall:"1",blapyaction:l.blapyaction,blapyobjectid:i}),"1"!=r&&(o=l);const c={method:p};"GET"===p.toUpperCase()?c.params=l:c.body=l,this.opts.theBlapy.ajaxService.request(n,c).then(t=>{t&&("object"==typeof t&&(t=JSON.stringify(t)),s&&(t=this.opts.theBlapy.embedHTMLPage(t,s)),this.trigger("pageLoaded",{htmlPage:t,params:l}))}).catch(t=>{this.trigger("errorOnLoadingPage",n+": "+t.message)})},next_state:"ProcessPageChange"},updateBlock:{init_function:function(t,e,a){this.opts.beforePageLoad&&this.opts.beforePageLoad(a),this.opts.theBlapy.trigger("Blapy_beforePageLoad",a),a&&a.html||(this.logger.info("updateBlock: no html property found"),this.trigger("errorOnLoadingPage","updateBlock: no html property found"))},out_function:function(t,e,a){if(!a)return;a.params||(a.params=""),"embeddingBlockId"in a.params&&!a.params.embeddingBlockId&&this.logger.info(`[updateBlock on ${this.myUIObjectID} embeddingBlockId has been set but is undefined! must be an error...]`);let n=a.params.embeddingBlockId;if("object"==typeof a.html&&(a.html=JSON.stringify(a.html)),n&&a.params.templateId){const t=this.myUIObject.querySelector(`[data-blapy-container-name='${n}']`);t&&t.setAttribute("data-blapy-template-default-id",a.params.templateId)}n&&(a.html=this.opts.theBlapy.embedHTMLPage(a.html,n)),this.trigger("pageLoaded",{htmlPage:a.html,params:a.params})},next_state:"ProcessPageChange"},reloadBlock:{init_function:function(t,e,a){let n={};a&&(n=a.params),"embeddingBlockId"in n&&!n.embeddingBlockId&&this.logger.info("[reloadBlock on "+this.myUIObjectID+"] embeddingBlockId has been set but is undefined! must be an error...",1),this.opts.theBlapy.setBlapyJsonTemplates(!0,n.embeddingBlockId,n.templateId),this.opts.theBlapy.setBlapyUpdateOnDisplay()}}},ProcessPageChange:{enterState:{},pageLoaded:{init_function:function(t,e,a){console.log("🎭 FSM pageLoaded triggered"),console.log("  - htmlPage preview:",a.htmlPage.substring(0,100)),console.log("  - params:",a.params);let n=a.htmlPage,r=a.params,i=r.blapyobjectid,o=this,l=null,s="undefined"!=typeof JSON5?JSON5:JSON;try{if(l=s.parse(n),n=l,n instanceof Array){let t=$(""),e="";for(let a=0;a<n.length;a++)e=this.opts.theBlapy.createBlapyBlock(n[a]),t=t.add(e);n=t}else"object"==typeof n?n=this.opts.theBlapy.createBlapyBlock(n):o.opts.theBlapy._log("downloaded content is not html neither json object, that's curious... "+n+" - "+containerName,1)}catch(p){}r.blapyaction,this.myUIObject[0].querySelectorAll("[data-blapy-container]").forEach(async t=>{let e=t,a=e.getAttribute("data-blapy-container-name");r["force-update"]||(r["force-update"]=0);let l=null;try{l=$(n).filter('[data-blapy-container-name="'+a+'"]').add($(n).find('[data-blapy-container-name="'+a+'"]')).first()}catch(p){return}if(!l||0===l.length)return;if(null!=l.attr("data-blapy-applyon")){let t=l.attr("data-blapy-applyon").split(",");if(t.length>0&&-1==$.inArray(i,t))return}l=l.get(0),e.id||o.opts.theBlapy.logger.warn("A blapy block has no id: "+e.outerHTML.substring(0,250)),l.id||(l.id=e.id);let c=l.getAttribute("data-blapy-update"),d=!1;("local"===e.getAttribute("data-blapy-update-rule")||"json"===c&&"json"!==e.getAttribute("data-blapy-update"))&&(c=e.getAttribute("data-blapy-update"),d=!0);let g=l.querySelector("xmp.blapybin");if(console.log(`🔧 [${a}] Has xmp.blapybin:`,!!g),"json"!==c&&g&&(l.innerHTML=this.opts.theBlapy.utils.atou(g.innerHTML),console.log(`🔧 [${a}] Decoded xmp content ${l.innerHTML}`)),o.opts.beforeContentChange&&o.opts.beforeContentChange(e),e.dispatchEvent(new CustomEvent("Blapy_beforeContentChange",{detail:this.myUIObject})),c&&"update"!==c)if("force-update"===c)d?e.innerHTML=l.innerHTML:e.outerHTML=l.outerHTML,e=l;else if("append"===c)l.insertAdjacentHTML("afterbegin",e.innerHTML),d?e.innerHTML=l.innerHTML:e.outerHTML=l.outerHTML,e=l;else if("prepend"===c)l.insertAdjacentHTML("beforeend",e.innerHTML),d?e.innerHTML=l.innerHTML:e.outerHTML=l.outerHTML,e=l;else if("replace"===c)e.innerHTML=l.innerHTML,e=l;else if("custom"===c)l.getAttribute("data-blapy-container-content")===e.getAttribute("data-blapy-container-content")&&1!=r["force-update"]||(o.opts.doCustomChange&&o.opts.doCustomChange(e,l),e.dispatchEvent(new CustomEvent("Blapy_doCustomChange",{detail:l})));else if("remove"===c){let t=e.parentNode;e.remove(),e=t}else if("json"===c)console.log(`📊 [${a}] Processing JSON update`),console.log(`📊 [${a}] tmpContainer:`,!!g),console.log(`📊 [${a}] myContainer:`,e.getAttribute("data-blapy-container-name")),console.log(`📊 [${a}] aBlapyContainer:`,l.getAttribute("data-blapy-container-name")),await o.opts.theBlapy.templateManager.processJsonUpdate(g,e,l,s,this.opts.theBlapy);else{let t=o.opts.theBlapy[c];t&&"function"==typeof t?l.getAttribute("data-blapy-container-content")===e.getAttribute("data-blapy-container-content")&&1!=r["force-update"]&&"true"!==l.getAttribute("data-blapy-container-force-update")||t(e,l):o.opts.theBlapy.logger.error(`${c} does not exist`)}else l.getAttribute("data-blapy-container-content")===e.getAttribute("data-blapy-container-content")&&1!=r["force-update"]||(d?e.innerHTML=l.innerHTML:e.outerHTML=l.outerHTML,e=l);if(o.opts.theBlapy.blapyBlocks.setBlapyUpdateIntervals(),o.opts.theBlapy.setBlapyUpdateOnDisplay(),o.opts.afterContentChange&&o.opts.afterContentChange(e),e.id){let t=document.getElementById(e.id);t&&t.dispatchEvent(new CustomEvent("Blapy_afterContentChange",{detail:e}))}})},out_function:function(t,e,a){this.opts.afterPageChange&&this.opts.afterPageChange(),this.opts.theBlapy.trigger("Blapy_afterPageChange",a)},next_state:"PageReady"},errorOnLoadingPage:{init_function:function(t,e,a){this.opts.onErrorOnPageChange&&this.opts.onErrorOnPageChange(a),this.opts.theBlapy.trigger("Blapy_ErrorOnPageChange",[a])},next_state:"PageReady"},reloadBlock:"loadUrl",updateBlock:"loadUrl",postData:"loadUrl",loadUrl:{how_process_event:{delay:50,preventcancel:!0},propagate_event:!0}},DefaultState:{start:{next_state:"PageLoaded"}}};if($(this.myUIObject).iFSM(t,this.optsIfsm),this.myFSM=$(this.myUIObject).getFSM(t),!this.router.init())return this.logger.error("Failed to initialize router","core"),!1;const e=this.myFSM.trigger;return this.myFSM.trigger=function(t,a){return e.call(this,t,a)},!0}catch(t){return this.logger.error(`Failed to initialize application: ${t.message}`,"core"),!1}}trigger(t,e=null){this.logger.info(`[Sending event] ${t} - Diffused`);const a=new CustomEvent(t,{detail:e,bubbles:!0});this.myUIObject.dispatchEvent(a)}setBlapyURL(){if(this.logger.info("Set blapyURL","router"),this.opts.enableRouter&&this.router.isInitialized)return void this.logger.info("Router enabled - Navigo will handle blapy links","router");this.container.querySelectorAll("[data-blapy-link]").forEach(t=>{const e=t.getAttribute("data-blapy-active-blapyId");if(e&&e!==this.myUIObjectID)return;let a,n=t.tagName;switch(n){case"A":a=t.getAttribute("href");break;case"FORM":a=t.getAttribute("action");break;default:a=t.getAttribute("data-blapy-href")}if(a){if(-1==a.indexOf("#blapylink")){a+="#blapylink";const e=t.getAttribute("data-blapy-embedding-blockid");null!==e&&""!==e&&(a+="#"+e)}if("A"===n)t.setAttribute("href",a);else if("FORM"===n)t.setAttribute("action",a);else{if(!a.startsWith("/")&&!/^https?:\/\//i.test(a)){const t=document.querySelector("base"),e=t?t.getAttribute("href"):null;a=e?e+a:window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")+1)+a}t.setAttribute("data-blapy-href",a),t.addEventListener("click",()=>{this.myFSM.trigger("loadUrl",{aUrl:a,params:{},aObjectId:this.myUIObjectID})})}}})}navigate(t,e={}){this.opts.enableRouter&&this.router.isInitialized?this.router.navigate(t,e):this.myFSM.trigger("loadUrl",{aUrl:t,params:e.params||{},aObjectId:this.myUIObjectID,noBlapyData:e.noBlapyData})}embedHTMLPage(t,e){this.logger.info("embedHTML","core");const a=this.myUIObject.querySelector("[data-blapy-container-name='"+e+"']");if(!a)return this.logger.error(`embedHtmlPage: Error on blapy-container-name... ${e} does not exist!`),"";if("json"===a.getAttribute("data-blapy-update")&&"0"===a.getAttribute("data-blapy-template-init-purejson"))try{t instanceof Element&&(t=t.innerHTML)}catch(l){this.logger.warn(`embedHtmlPage: aHtmlSource is perhaps a pure json after all...?\n${t}`)}const n='<xmp class="blapybin">'+this.utils.utoa(t)+"</xmp>",r=document.createElement("div");r.innerHTML=a.outerHTML;const i=r.firstElementChild;i.innerHTML=n;const o=i.getAttribute("data-blapy-container-content")||"";return i.setAttribute("data-blapy-container-content",o+"-"+Date.now()),i.removeAttribute("id"),i.outerHTML}async setBlapyJsonTemplates(t,e,a){if(this.logger.info("setBlapyJsonTemplates","core"),null==t&&(t=!1),e=e?`[data-blapy-container-name='${e}']`:"",a){const t='[data-blapy-update="json"]'+e;this.container.querySelectorAll(t).forEach(t=>{t.setAttribute("data-blapy-template-default-id",a)})}let n=this.container.querySelectorAll('[data-blapy-update="json"]'+e);if(n.length>0){for(const e of n)await this.templateManager.setBlapyContainerJsonTemplate(e,this,t);this.myFSM.trigger("blapyJsonTemplatesIsSet")}else this.myFSM.trigger("blapyJsonTemplatesIsSet")}async setBlapyUpdateOnDisplay(){this.logger.info("setBlapyUpdateOnDisplay","core");const t=this.myUIObject.querySelectorAll("[data-blapy-updateblock-ondisplay]");if(0===t.length)return;if(!("IntersectionObserver"in window))return void alert("Blapy: IntersectionObserver is not supported. Need it to process data-blapy-updateblock-ondisplay option");const e=this,a=new IntersectionObserver((t,a)=>{t.forEach(t=>{if(t.isIntersecting){const n=t.target;if(!n.hasAttribute("data-blapy-appear"))if(n.setAttribute("data-blapy-appear","done"),this.logger.info(`Element became visible: ${n.getAttribute("data-blapy-container-name")}`,"setBlapyUpdateOnDisplay"),n.hasAttribute("data-blapy-href"))e.myFSM.trigger("loadUrl",{aUrl:n.getAttribute("data-blapy-href"),params:{},aObjectId:e.myUIObjectID,noBlapyData:n.getAttribute("data-blapy-noblapydata")});else if(n.hasAttribute("data-blapy-template-init")){const t=n.getAttribute("data-blapy-container-name");e.myFSM.trigger("reloadBlock",{params:{embeddingBlockId:t}})}a.unobserve(n)}})},{root:null,rootMargin:"0px",threshold:.1});t.forEach(t=>{this.logger.info(`Observing element: ${t.getAttribute("data-blapy-container-name")}`,"setBlapyUpdateOnDisplay"),a.observe(t)})}createBlapyBlock(t){return t["blapy-container-name"]||this._log("createBlapyBlock: Error on received json where blapy-container-name is not defined!\nPerhaps it's pure json not defined as such in Blapy block configuration (cf. data-blapy-template-init-purejson)...\n"+JSON.stringify(t),1),$("<div/>",{"data-blapy-container":!0,"data-blapy-container-name":t["blapy-container-name"],"data-blapy-container-content":t["blapy-container-content"],"data-blapy-update":"json"}).html(JSON.stringify(t["blapy-data"]))}}function createBlapy(t,e={}){}function enableJQueryLikeSyntax(){"undefined"==typeof window||window.$blapy||(window.$blapy=function(t){const e="string"==typeof t?document.querySelector(t):t;if(!e)throw new Error(`Element not found: ${t}`);return{Blapy:function(t={}){return e.Blapy(t)}}})}HTMLElement.prototype.Blapy=function(t={}){if(this._blapyInstance)return this._blapyInstance;const e=new Blapy(this,t);return e.initApplication(),this._blapyInstance=e,e},enableJQueryLikeSyntax&&enableJQueryLikeSyntax(),window.Blapy2={Blapy:Blapy,createBlapy:createBlapy,Logger:Logger,Utils:Utils,AjaxService:AjaxService,TemplateManager:TemplateManager,Router:Router,BlapyBlock:BlapyBlock}})();
