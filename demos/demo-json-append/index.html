<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blapy2 - JSON Append Example</title>

    <!-- Required libraries -->
    <script src="../../lib/jquery/jquery-3.7.1.min.js"></script>
    <script src="../../lib/mustache/mustache.js"></script>
    <script src="../../lib/navigo/index.js"></script>
    <script src="../../lib/iFSM/extlib/jquery.attrchange.js"></script>
    <script src="../../lib/iFSM/extlib/jquery.dotimeout.js"></script>
    <script src="../../lib/json5/index.min.js"></script>
    <script src="../../lib/iFSM/iFSM.js"></script>
    <script src="../../lib/json2html/json2html.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }

      h1 {
        color: #333;
        text-align: center;
      }

      .task-list {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .task {
        padding: 10px;
        margin: 10px 0;
        background: #f9f9f9;
        border-left: 3px solid #4caf50;
        border-radius: 4px;
      }

      .task-title {
        font-weight: bold;
        color: #333;
      }

      .task-time {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
      }

      .controls {
        text-align: center;
      }

      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }

      button:hover {
        background: #45a049;
      }

      .info {
        text-align: center;
        color: #666;
        margin-top: 10px;
      }

      .empty-state {
        text-align: center;
        color: #999;
        padding: 20px;
      }
    </style>
  </head>

  <body id="myBlapy">
    <h1>üìù My Task List</h1>

    <div
      class="task-list"
      data-blapy-container="true"
      data-blapy-container-name="tasks"
      data-blapy-update="json-append"
      data-blapy-json-append-strategy="start"
      data-blapy-json-max-items="10"
    >
      <xmp data-blapy-container-tpl="true" style="display: none">
        {{#.}}
        <div class="task">
          <div class="task-title">{{title}}</div>
          <div class="task-time">Added at {{time}}</div>
        </div>
        {{/.}}
        {{^.}}
        <div class="empty-state">No tasks for now</div>
        {{/.}}
      </xmp>

      <div class="empty-state">No tasks for now</div>
    </div>

    <div class="controls">
      <button id="addTask">‚ûï Add a task</button>
      <button id="addMultiple">‚ûï‚ûï Add 3 tasks</button>
      <button id="clearTasks">üóëÔ∏è Reset with 10 new tasks</button>
    </div>

    <div class="info">
      <small>Maximum 10 tasks ‚Ä¢ New tasks appear at the top</small>
    </div>
  </body>

  <script type="module">
    import { Blapy } from '../../src/index.js'
    const blapy = document
      .querySelector('#myBlapy')

      blapy.Blapy({
        debug: true,
        logLevel: 3,
      })

    blapy.addEventListener('Blapy_beforePageLoad', (event, error) => {
      alert(`Blapy error ${event}`)
    })

    let taskCounter = 1

    function getCurrentTime() {
      return new Date().toLocaleTimeString('en-GB')
    }

    function createTask(title) {
      return {
        id: taskCounter++,
        title: title || `Task #${taskCounter - 1}`,
        time: getCurrentTime(),
      }
    }

    document.getElementById('addTask').addEventListener('click', () => {
      const newTask = createTask()
      blapy.myFSM.trigger('updateBlock', {
        html: JSON.stringify({
          'blapy-container-name': 'tasks',
          'blapy-container-content': 'new-task',
          'blapy-data': newTask,
        }),
        params: {
          blapyobjectid: 'myBlapy',
          blapyaction: 'update',
        },
      })
    })

    document.getElementById('addMultiple').addEventListener('click', () => {
      const newTasks = []
      for (let i = 0; i < 3; i++) {
        newTasks.push(createTask())
      }

      blapy.myFSM.trigger('updateBlock', {
        html: JSON.stringify({
          'blapy-container-name': 'tasks',
          'blapy-container-content': 'new-tasks-batch',
          'blapy-data': newTasks,
        }),
        params: {
          blapyobjectid: 'myBlapy',
          blapyaction: 'update',
        },
      })
    })

    document.getElementById('clearTasks').addEventListener('click', () => {
      const container = document.querySelector(
        '[data-blapy-container-name="tasks"]'
      )
      container.setAttribute('data-blapy-json-data', '[]')

      const resetTasks = []
      for (let i = 0; i < 10; i++) {
        resetTasks.push(createTask(`Reset Task #${i + 1}`))
      }

      blapy.myFSM.trigger('updateBlock', {
        html: JSON.stringify({
          'blapy-container-name': 'tasks',
          'blapy-container-content': 'reset-tasks',
          'blapy-data': resetTasks,
        }),
        params: {
          blapyobjectid: 'myBlapy',
          blapyaction: 'update',
          'force-update': 1,
        },
      })

      taskCounter += 10
    })

    document
      .querySelector('.task-list')
      .addEventListener('Blapy_jsonAppended', (event) => {
        console.log('üéâ JSON Append done!', event.detail)
      })
  </script>
</html>
